
@{
    ViewBag.Title = "后台管理员";
}
<!--[if lt IE 9]>
<script type="text/javascript" src="lib/html5shiv.js"></script>
<script type="text/javascript" src="lib/respond.min.js"></script>
<![endif]-->
@Scripts.Render("~/bundles/saos")
@Styles.Render("~/appcss")
<!--[if IE 6]>
<script type="text/javascript" src="lib/DD_belatedPNG_0.0.8a-min.js" ></script>
<script>DD_belatedPNG.fix('*');</script>
<![endif]-->
<nav class="breadcrumb"><i class="Hui-iconfont">&#xe67f;</i> 首页 <span class="c-gray en">&gt;</span> 系统管理 <span class="c-gray en">&gt;</span> 后台管理员 <a class="btn btn-success radius r" style="line-height:1.6em;margin-top:3px" href="javascript:location.replace(location.href);" title="刷新"><i class="Hui-iconfont">&#xe68f;</i></a></nav>
<div class="page-container">
    <div class="cl pd-5 bg-1 bk-gray mt-10 search-wrap">
        <span class="label-inline">用户名：</span>
        <input type="text" id="userName" placeholder="请输入用户名" class="input-text lg inline" />
        <span class="label-inline">状态：</span>
        <select id="sel_userState" class="select select-box inline">
            <option value="-1">全部</option>
            <option value="1">启用</option>
            <option value="0">禁用</option>
        </select>
        <span class="label-inline">创建时间：</span>
        <input type="text" onclick="WdatePicker()" placeholder="创建时间" id="sTime" class="input-text inline Wdate" />
        <button name="search" id="search" class="btn btn-success ml-10" type="button"><i class="Hui-iconfont">&#xe665;</i> 搜索</button>
        <button class="btn btn-warning" onclick="resAdmin_add('添加管理员','@Url.Action("Add")')" type="button">添加管理员</button>
    </div>
    <div class="mt-10">
        <table id="tbTable" class="table table-border table-bordered table-bg table-sort">
            <thead>
                <tr class="text-c">
                    <th width="8%">序号</th>
                    <th width="20%">用户名</th>
                    <th width="15%">手机号</th>
                    <th width="14%">角色</th>
                    <th width="14%">状态</th>
                    <th width="14%">创建时间</th>
                    <th width="15%">管理</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

@Scripts.Render("~/bundles/datatable")
@section scripts {

    <script>
        var roleList = '@Html.Raw(ViewBag.state)';
        function checkValue(idstr) {
            if (roleList.length > 0) {
                var objjson = JSON.parse(roleList);
                for (var i in objjson) {
                    if (objjson[i].Id == idstr)
                        return objjson[i].RoleName;
                }
            }
        }
        function ChangeDateFormat(val) {
            if (val != null) {
                var date = new Date(parseInt(val.replace("/Date(", "").replace(")/", ""), 10));
                //月份为0-11，所以+1，月份小于10时补个0
                var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
                var currentDate = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
                return date.getFullYear() + "-" + month + "-" + currentDate;
            }
            return "";
        }
    </script>

    <script type="text/javascript">
        var table1 = null;
        $(function () {
            table1 = initializeTable();
            $("#search").click(function () {
                table1.ajax.reload();
            });

            //输入名称回车查询
            $("#userName").keypress(function (e) {
                if (e.which == 13) {
                    table1.ajax.reload();
                    $("#search").focus();
                }
            });
        });

        /*更新*/
        function admin_update(title, url, id) {
            var index = layer.open({
                type: 2,
                title: title,
                area: ['700px', '500px'],
                content: url + "?id=" + id
            });
        }
        /*添加*/
        function resAdmin_add(title, url) {
            var index = layer.open({
                type: 2,
                title: title,
                area: ['700px', '550px'],
                content: url
            });
        }

        /*删除*/
        function admin_del(obj, id) {
            layer.confirm('确认要删除该管理员吗？', function (index) {
                var thisobj = $(obj);
                $.getJSON("/ResAdmin/delete", { id: id }, function (data) {
                    if (data.isSuccess) {
                        layer.alert('操作成功！', {
                            icon: 6,
                            closeBtn: 0,
                            yes: function () {
                                table1.ajax.reload();
                                layer.closeAll();
                            }
                        });
                    } else
                        layer.alert(data.message, { icon: 5 });
                })
            });
        }
        function initializeTable() {
            var dataTable = $('#tbTable').DataTable({
                "serverSide": true,
                "bRetrieve": true,
                "ajax": {
                    "url": "@Url.Action("GetJsonData")",
                    "type": "post",
                    "data": function (data) {
                        data.pageIndex = (data.start / data.length) + 1;
                        data.name = $("#userName").val();
                        data.state = $("#sel_userState").val();
                        data.stime = $("#sTime").val();
                    }
                },
                "columns": [
                    { "defaultContent": "" },
                    { "mDataProp": "UserName" },
                    { "mDataProp": "Phone" },
                    { "mDataProp": "RoleId" },
                    { "mDataProp": "State" },
                    { "mDataProp": "CreateTime" },
                    { "defaultContent": "" }
                ],
                "columnDefs": [
                 {
                     "targets": [4],
                     "data": "State",
                     "render": function (data, type, full) {
                         var result = data;
                         if (data)
                             result = "<span class=\"label label-success radius\">启用</span>";
                         else
                             result = "<span class=\"label label-danger radius\">禁用</span>";
                         return result;
                     }
                 },
                {
                    "targets": [-1],
                    "data": "Id",
                    "render": function (data, type, full) {
                        if (full.IsSupAdmin && "@ViewBag.IsAdmin"=="False") {
                        return  "不可操作"
                        } else {
                            var tmpString = "<a href=\"javascript:;\" onClick=\"admin_update('修改管理员','@Url.Action("Update")'," + data + ")\"  title=\"修改\">修改</a>";
                            if(!full.IsSupAdmin){
                                tmpString += "<a href=\"javascript:;\" onClick=\"admin_del(this," + data + ")\"  title=\"删除\">删除</a>";
                            }
                            return tmpString;
                        }
                     
                    }
                }, {
                    "targets": [3],
                    "data": "RoleId",
                    "render": function (data, type, full) {
                        return checkValue(data)
                    }
                }, {
                    "targets": [5],
                    "data": "CreateTime",
                    "render": function (data, type, full) {
                        return ChangeDateFormat(data)
                    }
                }
                ],
                "fnDrawCallback": function () {
                    var api = this.api();
                    var startIndex = api.context[0]._iDisplayStart;
                    api.column(0).nodes().each(function (cell, i) {
                        cell.innerHTML = startIndex + i + 1;
                    });
                },
                "rowCallback": function (row, data, displayIndex) {
                    $(row).attr("class", "text-c");
                    $(row).children('td').eq(6).attr("class", "td-manage");
                },
                "initComplete": function (settings, json) {

                },
                language: {
                    lengthMenu: '',
                    loadingRecords: '数据加载中...',
                    paginate: {
                        previous: "上一页",
                        next: "下一页",
                        first: "",
                        last: ""
                    },
                    zeroRecords: "暂无数据",

                    info: "<span class='pagesStyle'>总共<span class='recordsStyle'> _TOTAL_ 条,计 _PAGES_ </span>页，当前显示 _START_ -- _END_ 条记录 </span>",
                    infoEmpty: "0条记录",
                    infoFiltered: ""
                },
                "searching": false,
                "ordering": false,
                "autoWidth": false,
                "iDisplayLength": 10,
                "processing": true,
                //destroy: true, //Cannot reinitialise DataTable,解决重新加载表格内容问题

            });
            return dataTable;
        }

    </script>
}